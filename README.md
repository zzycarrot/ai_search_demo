# 文档搜索引擎

## 主要特性

- **多线程架构**: 后台监听 + 前台交互
- **自动化监听**: 使用 `notify` 库监听文件变化，自动处理新文档
- **实时搜索**: 支持实时输入关键词进行搜索
- **持久化存储**: 基于 Tantivy 的磁盘索引，数据永久保存
- **中文分词**: 集成 Jieba 分词，支持中文搜索
- **多格式支持**: 支持 `.txt`, `.md`, `.pdf` 等格式
- **高性能**: 使用内存映射文件 (MmapDirectory) 实现高效存储

## 系统要求

- Linux /MacOS
- Rust 

## 安装和使用

### 1. 编译项目

```bash
cargo build --release
```

### 2. 准备目录

```bash
# 创建监听目录和索引存储目录
mkdir -p docs storage
```

### 4. 启动全栈服务

```bash
cargo run
```

服务启动后会显示：
```
--- 文件搜索系统 ---
 [后台] 正在监控: "./docs"
 [前台] 输入关键词进行搜索 (输入 'quit' 退出)
 [后台] 正在扫描现有文件...
 正在解析: "./docs/xxx.txt"
 [后台] 新文件已索引: xxx (输入搜索词继续)
 [后台] 初始索引完成，共处理 X 个文件
>
```

**重要特性**：
- **自动初始化**：启动时自动扫描并索引所有现有文档
- **实时监听**：持续监控文件变化，自动处理新文档
- **即时搜索**：支持实时输入关键词进行搜索

### 4. 实时搜索

在提示符后输入关键词：
```bash
> 人工智能
 [文档标题] /path/to/document.txt

> 机器学习
 [文档标题] /path/to/document.txt

> quit  # 退出程序
```

### 5. 后台自动索引

保持程序运行，在另一个终端添加文档：

```bash
echo "新的AI研究内容" > docs/new_ai_paper.txt
```

主程序会自动显示：
```
 [后台] 新文件已索引: new_ai_paper (输入搜索词继续)
>
```

## 🔍 核心架构

### 多线程设计

```
┌─────────────────┐    ┌─────────────────┐
│   主线程        │    │   后台线程      │
│   (用户交互)    │    │   (文件监听)    │
├─────────────────┤    ├─────────────────┤
│ • 接受用户输入  │    │ • 监听文件变化  │
│ • 解析搜索查询  │    │ • 提取文档内容  │
│ • 执行搜索      │    │ • 写入索引      │
│ • 显示结果      │    │ • 提交持久化    │
└─────────────────┘    └─────────────────┘
         │                       │
         └─────── 共享 ──────────┘
                 Tantivy Index
```

### 线程安全

- **Index 克隆**: `index.clone()` 只复制轻量级引用，不复制数据
- **MVCC 并发**: Tantivy 使用多版本并发控制，保证读写安全
- **自动同步**: Reader 自动感知 Writer 的提交变化

## 📁 目录结构

```
.
├── docs/          # 监听的文档目录
├── storage/       # 索引数据存储目录
├── src/
│   ├── main.rs    # 主程序（多线程架构）
│   ├── lib.rs     # 库接口
│   ├── extract.rs # 文档提取逻辑
│   ├── search.rs  # 搜索功能（可扩展）
│   ├── models.rs  # 数据结构
│   └── config.rs  # 配置常量
└── Cargo.toml     # 项目配置
```

## 🏗️ 技术架构

### 核心组件

1. **文件监听**: `notify` 库 + inotify 系统调用
2. **搜索引擎**: Tantivy 搜索引擎
3. **中文分词**: tantivy-jieba
4. **文档解析**: pdf-extract, 内置文本处理
5. **多线程**: Rust std::thread

### 处理流程

```
启动程序 → 扫描现有文件 → 建立初始索引 → 启动文件监听
     ↓              ↓              ↓              ↓
新文件添加 → 文件系统事件 → 后台线程处理 → 更新索引
用户输入查询 ← 主线程处理 ← 解析查询 ← 搜索索引 ← 返回结果
```

### 存储特性

- **MmapDirectory**: 内存映射文件，性能优异
- **自动恢复**: 重启服务后自动加载现有索引
- **ACID 保证**: Tantivy 提供事务性提交
- **线程安全**: 支持并发读写操作
- **初始扫描**: 启动时自动处理所有现有文档

## 工作流程

### 完整生命周期

1. **启动阶段**
   - 初始化 Tantivy 索引
   - 扫描 `./docs` 目录下的所有文档
   - 建立初始索引数据库

2. **运行阶段**
   - 后台监听文件系统变化
   - 前台接受用户搜索请求
   - 实时更新索引

3. **文件处理优化**
   - **防抖机制**: 基于文件修改时间，避免重复处理
   - **去重索引**: 同一文件只保留最新版本
   - **延迟处理**: 等待文件写入完成再处理

4. **搜索阶段**
   - 解析用户查询
   - 在索引中执行搜索
   - 返回相关文档列表

## 高级配置

### 自定义监听目录

修改 `main.rs` 中的路径：

```rust
let watch_path = Path::new("./your_docs");    // 自定义监听目录
let storage_path = Path::new("./your_index"); // 自定义索引目录
```

### 支持更多文件格式

在 `extract.rs` 中添加新的文件类型处理：

```rust
match extension {
    "txt" | "md" => fs::read_to_string(path)?,
    "pdf" => pdf_extract::extract_text(path)?,
    "docx" => process_docx(path)?,  // 新增
    _ => return Err(anyhow::anyhow!("不支持的文件格式")),
}
```

## 故障排除

### 服务启动失败

- 检查目录权限
- 确保没有其他进程占用端口
- 查看错误日志

### 初始扫描失败

- 检查文档目录权限
- 确认文件格式支持（txt/md/pdf）
- 查看启动时的错误信息

### 文件未被索引

- 检查文件格式是否支持
- 确认文件完整写入（监听服务有 100ms 防抖）
- 查看控制台输出日志
- 对于现有文件：重启服务会重新扫描

### 搜索无结果

- 确认文档已被后台线程处理
- 检查关键词是否正确
- 尝试不同的搜索词

### 索引文件损坏

删除 `storage` 目录，重新启动服务：

```bash
rm -rf storage/
cargo run
```

##  性能优化

### 文件监听优化

- **智能防抖**: 使用文件修改时间而非事件时间戳，避免文件复制时的多次触发
- **去重索引**: 自动删除旧版本，保持索引清洁
- **延迟处理**: 500ms 延迟确保文件写入完成
- **内存管理**: 自动清理过期记录，防止内存泄漏

### 索引性能

- **MmapDirectory**: 内存映射文件，读写性能优异
- **多版本并发**: MVCC 支持并发读写
- **中文分词**: Jieba 分词器优化中文搜索
- **批量提交**: 减少磁盘I/O操作

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

## 📄 许可证

MIT License